<script type="text/javascript">

  RED.nodes.registerType('trelloGetNewCard', {
    category: 'Trello',
    color: '#8BBDD9',
    defaults: {
      trello: {value: '', required: true, type: 'trelloCredentials'},
      idList: {value: '', required: false},
      idBoard: {value: '', required: false},
      excludeUser: {value:false, required: true},
      safeListBlockListUsers: {value: 'block', required: true},
      filterUserList: {value:[], required: false},
      name:{value:'', required: false}
    },
    inputs: 1,
    outputs: 1,
    icon: "trello.png",
    label: function () {
      return this.name || this._('trelloGetNewCard.nodeName');
    },
    paletteLabel: function () {
      //<editor-fold desc="TrelloBoardListWidget">
      /**
       * options:
       *  - onSelect: funtion(to decide) - called when item is selected
       *
       *
       *
       *  - trelloCredentials:
       *
       * method:
       *  - setCredentials(trelloCredentials)
       *
       *  - setItem()
       *  - getItems()
       *  - length()
       *  - getItem()
       *
       *
       */
      // todo maybe in the future i can have all the string constants like, loading list and select to narrow, able to be set as options but since I don't have multiple languages atm I'm going to leave it till later
      $.widget("trelloFunctions.selectTrelloBoard", {
        _create: function () {
          // const boardSelector = this.element;
          //
          // if (this.options.onSelect != null)
          // {
          //   //todo maybe do some function type check
          //   let onSelectFunction = this.options.onSelect;
          //   boardSelector.change(function (e){onSelectFunction(e)});
          // }
        },
        setOnSelect: function (onSelectFunction)
        {
          const boardSelector = this.element;
          boardSelector.change(function (e){onSelectFunction(e)});
          console.log('set function');
        },
        setCredentials: function (credentialsNode, currentBoardID) {
          const boardSelector = this.element;

          if (credentialsNode != null) {
            if (credentialsNode.apikey && credentialsNode.token) {
              boardSelector.empty();

              boardList = $("#node-input-idBoard");
              boardList.empty();
              // clear the list and add a placeholder to show it loading
              const boardListFirstConainer = $('<option/>', {class: "node-input-option-node", value: ''});
              // const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text(originalContext._("trelloGetNewCard.hint.boardListLoading"));
              const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text('Loading Boards...');
              boardListFirstText.appendTo(boardListFirstConainer);
              boardListFirstConainer.appendTo(boardSelector);

              // Get Trello boards assigned to user
              const url = 'https://api.trello.com/1/members/me/boards?key=' + credentialsNode.apikey + '&token=' + credentialsNode.token;
              $.get(url, function (data, status) {
                boardSelector.empty();
                const boardListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
                // const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text(originalContext._("trelloGetNewCard.hint.boardListUnselected"));
                const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text('Select a Board to narrow results');
                boardListFirstText.appendTo(boardListFirstContainer);
                boardListFirstContainer.appendTo(boardSelector);

                for (let i = 0; i < data.length; i++) {
                  let container = $('<option/>', {class: "node-input-option-node", value: data[i].id});
                  if (currentBoardID === data[i].id) {
                    container = $('<option/>', {
                      class: "node-input-option-node",
                      selected: "selected",
                      value: data[i].id
                    });
                  }

                  const textName = $('<span>', {class: "node-input-option-text"}).text(data[i].name + ": ");
                  const textID = $('<span>', {
                    class: "node-input-option-text",
                    style: "color: grey;"
                  }).text(data[i].id); // for some reason can't change the colour

                  textID.appendTo(textName);
                  textName.appendTo(container);
                  container.appendTo(boardSelector);
                }
                boardSelector.change(); // used to trigger update in list list
              });
            }

          } else {
            const boardListFirstConainer = $('<option/>', {class: "node-input-option-node", value: ''});
            // const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text(originalContext._("trelloGetNewCard.hint.boardListLoading"));
            const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text('Please select Trello credentials first');
            boardListFirstText.appendTo(boardListFirstConainer);
            boardListFirstConainer.appendTo(boardSelector);

          }
        },
      });
      //</editor-fold>
      //<editor-fold desc="TrelloListListWidget">
      /**
       * options:
       *  - onSelect: funtion(to decide) - called when item is selected
       *
       * method:
       *  - setBoard(trelloCredentials, currentBoardID, currentListID)
       *
       */
      $.widget("trelloFunctions.selectTrelloList", {
        _create: function () {
          const listSelector = this.element;

          if (this.options.onSelect != null)
          {
            //todo maybe do some function type check
            let onSelectFunction = this.options.onSelect;
            listSelector.change(function (e){onSelectFunction(e)});
          }

        },
        setBoard: function (credentialsNode, currentBoardID, currentListID) {
          const listSelector = this.element;
          if (credentialsNode != null) {
            if (credentialsNode.apikey && credentialsNode.token) {
              // clear the list ready for populating
              listSelector.empty();


              if (currentBoardID !== '') { // happens when value isn't selected for board add loading placeholder
                  const listListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
                  // const listListFirstText = $('<span>', {class: "node-input-option-text"}).text(originalContext._("trelloGetNewCard.hint.listListLoading"));
                  const listListFirstText = $('<span>', {class: "node-input-option-text"}).text("loading... ");
                  listListFirstText.appendTo(listListFirstContainer);
                  listListFirstContainer.appendTo(listSelector);

                  const url = 'https://api.trello.com/1/boards/' + currentBoardID + '/lists?key=' + credentialsNode.apikey + '&token=' + credentialsNode.token;
                  $.get(url, function (data, status) {
                    // Now we have the list data clear the list again and update it with a hint and each Trello list
                    listSelector.empty();
                    // hint
                    const containerFirst = $('<option/>', {class: "node-input-option-node", value: ''});
                    // const text = $('<span>', {class: "node-input-option-text"}).text(originalContext._("trelloGetNewCard.hint.listListUnselected"));
                    const text = $('<span>', {class: "node-input-option-text"}).text("Select a list to narrow results");
                    text.appendTo(containerFirst);
                    containerFirst.appendTo(listSelector);
                    // hint
                    for (let i = 0; i < data.length; i++) { // Add all cards in Trello list to selection box, no need to check if it is the same as the
                      let container = $('<option/>', {class: "node-input-option-node", value: data[i].id});

                      if (currentListID === data[i].id) { // if we are loading the list that has been previously selected then we will have a list ID, here i make sure that is the selected option
                        container = $('<option/>', {
                          class: "node-input-option-node",
                          selected: "selected",
                          value: data[i].id
                        });
                      }
                      const textName = $('<span>', {class: "node-input-option-text"}).text(data[i].name + ": ");
                      const textID = $('<span>', {
                        class: "node-input-option-text",
                        style: "color: grey;"
                      }).text(data[i].id); // for some reason can't change the colour
                      textID.appendTo(textName);
                      textName.appendTo(container);
                      container.appendTo(listSelector);
                    }
                  });

                } else {
                  const listListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
                  // const listListFirstText = $('<span>', {class: "node-input-option-text"}).text(originalContext._(originalContext._("trelloGetNewCard.hint.listListBoardUnselected")));
                  const listListFirstText = $('<span>', {class: "node-input-option-text"}).text("please select a board");
                  listListFirstText.appendTo(listListFirstContainer);
                  listListFirstContainer.appendTo(listSelector);
                }
            }
          } else {
            const boardListFirstConainer = $('<option/>', {class: "node-input-option-node", value: ''});
            // const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text(originalContext._("trelloGetNewCard.hint.boardListLoading"));
            const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text('Please select Trello credentials first');
            boardListFirstText.appendTo(boardListFirstConainer);
            boardListFirstConainer.appendTo(listSelector);

          }
        },
      });
      //</editor-fold>
      return this.name || this._('trelloGetNewCard.nodeName');
    },
    oneditprepare: function () {
      function resizeRule(rule) {
        const newWidth = rule.width();
        rule.find('.red-ui-typedInput').typedInput("width",(newWidth-15)/2);
      }
      const originalContext = this;
      const listSelector = $('#node-input-idList').selectTrelloList({});
      const boardSelector = $('#node-input-idBoard').selectTrelloBoard({});

      function setupHooks(trelloID) {
        let boardList;
        let credentialNode;
        if (trelloID) {
          credentialNode = RED.nodes.node(trelloID);
        } else {
          credentialNode = RED.nodes.node(originalContext.trello);
        }



        if (credentialNode) {
          if (credentialNode.apikey && credentialNode.token) {
            // todo make use od set credentialss
            boardSelector.selectTrelloBoard('setOnSelect',
              function (e) {
                const board = $("#node-input-idBoard");
                const boardID = $(board).val(); // Gets the ID of the selected board

                listSelector.selectTrelloList('setBoard', credentialNode, boardID, originalContext.idList);

                if (boardID !== '') {
                  const membersURL = 'https://api.trello.com/1/boards/' + boardID + '/members?key=' + credentialNode.apikey + '&token=' + credentialNode.token;

                  $.get(membersURL, function (data, status) {
                    let container = $("#node-input-filterUserList-hints");
                    container.empty();

                    const text = $('<span>', {style: "color: grey; font-size: 11px"}).text('JSON dump of members on board \n' + JSON.stringify(data));
                    text.appendTo(container);
                  });
                }

              }
            );
            boardSelector.selectTrelloBoard('setCredentials', credentialNode,originalContext.idBoard);
          }
        } else { // No trello credentials fill both selection boxes with hints to select credentials
          boardList = $("#node-input-idBoard");
          boardList.empty();
          const boardListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
          const boardListFirstText = $('<span>', {class: "node-input-option-text"})
              .text(originalContext._(originalContext._("trelloGetNewCard.hint.noTrelloCredentials")));
          boardListFirstText.appendTo(boardListFirstContainer);
          boardListFirstContainer.appendTo(boardList);

          const listList = $("#node-input-idList");
          listList.empty();
          const listListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
          const listListFirstText = $('<span>', {class: "node-input-option-text"})
              .text(originalContext._(originalContext._("trelloGetNewCard.hint.noTrelloCredentials")));
          listListFirstText.appendTo(listListFirstContainer);
          listListFirstContainer.appendTo(listList);
        }
      }


      $("#node-input-trello").change(function (e) { // rerun if credentials changed
        const trelloID = $(this).val();
        setupHooks(trelloID);
      });


      // Populate the boxes with the only values we have stored
      if (this.idList) {
        const listList = $("#node-input-idList");
        listList.empty();
        const listListFirstContainer = $('<option/>', {class: "node-input-option-node", value: this.idList});
        const listListFirstText = $('<span>', {class: "node-input-option-text"}).text(this.idList);
        listListFirstText.appendTo(listListFirstContainer);
        listListFirstContainer.appendTo(listList);
      }

      if (this.idBoard) {
        let boardList = $("#node-input-idList");
        boardList.empty();
        const boardListFirstContainer = $('<option/>', {class: "node-input-option-node", value: this.idBoard});
        const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text(this.idBoard);
        boardListFirstText.appendTo(boardListFirstContainer);
        boardListFirstContainer.appendTo(boardList);
      }

      setupHooks();

      const headerList = $("#node-input-filterUserList-container").css('min-height', '150px').css('min-width', '450px').editableList({
        addItem: function (container, index, value) {
          const row = $('<div/>').css({
            overflow: 'hidden',
            whiteSpace: 'nowrap'
          }).appendTo(container);

          const labal = $('<label>User ID</label>', {value: "trelloGetCardMovedToList.label.selectBoardID"})
            .appendTo(row);

          const propertyName = $('<input/>', {class: "node-input-filterUserList-userID", type: "text"})
            .appendTo(row);
          console.log(propertyName[0]);
          console.log(value);
          if ('inputValue' in value) {
            propertyName[0].value = value.inputValue;
          }

          resizeRule(container);
        },
        resizeItem: resizeRule,
        removable: true
      });
      for (let i = 0; i < this.filterUserList.length; i++) {
        headerList.editableList('addItem', {inputValue: this.filterUserList[i]});
      }
    },
    oneditsave: function () {
      const headers = $("#node-input-filterUserList-container").editableList('items');
      const node = this;
      node.filterUserList = [];
      headers.each(function (i) {
        const userRow = $(this);
        const userID = userRow.find(".node-input-filterUserList-userID");
        if (userID.length === 1) { // idk what to do if its not 1
          const text = userID[0].value;
          node.filterUserList.push(text);
          console.log(JSON.stringify(node.filterUserList));

        }
      });
    },
    oneditresize: function (size) {
      const rows = $("#dialog-form>div:not(.node-input-filterUserList-container-row)");
      let height = size.height;
      for (let i = 0; i < rows.size(); i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      const editorRow = $("#dialog-form>div.node-input-filterUserList-container-row");
      height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));

      $("#node-input-filterUserList-container").editableList('height', height);
    }
  });
</script>

<script type="text/x-red" data-template-name="trelloGetNewCard">
    <div class="form-row">
      <label for="node-input-trello">Trello</label>
      <input id="node-input-trello"></input>
    </div>
    <div class="form-row">
      <label for="node-input-idBoard" data-i18n="trelloGetNewCard.label.selectBoardID"></label>
      <select id="node-input-idBoard" >
      </select>
    </div>
    <div class="form-row">
      <label for="node-input-idList" data-i18n="trelloGetNewCard.label.selectListID"></label>
      <select id="node-input-idList" >
      </select>
    </div>
    <div class="form-row">
      <label for="node-input-excludeUser" data-i18n="trelloGetNewCard.label.excludeUserBoolean"></label>
      <input id="node-input-excludeUser" type="checkbox"></input>
    </div>
    <div class="form-row">
      <label for="node-input-safeListBlockListUsers" data-i18n="trelloGetNewCard.label.safeBlockListSelect"></label>
      <select id="node-input-safeListBlockListUsers" >
          <option value="block">Block</option>
          <option value="safe">Safe</option>
      </select>
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="trelloGetNewCard.label.filterUserList"></span></label>
    </div>
    <div class="form-row node-input-filterUserList-container-row">
      <ol id="node-input-filterUserList-container"></ol>
    </div>
    <div class="form-row " id="node-input-filterUserList-hints">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="trelloGetNewCard.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]trelloGetNewCard.label.name">
    </div>

</script>
