<script type="text/javascript">

  RED.nodes.registerType('trelloGetList', {
    category: 'Trello',
    color: '#8BBDD9',
    defaults: {
      trello: {value: '', required: true, type: 'trelloCredentials'},
      idList: {value: '', required: false},
      idBoard: {value: '', required: true},
      outputAsArray: {value: false, required: true},
      name: {value: '', required: false}
    },
    inputs: 1,
    outputs: 1,
    icon: "trello.png",
    label: function () {
      return this.name || this._('trelloGetList.nodeName');
    },
    paletteLabel: function () {
      return this.name || this._('trelloGetList.nodeName');
    },
    oneditprepare: function () {
      const originalContext = this;

      function setupHooks(trelloID) {
        let boardList;
        let credentialNode;
        if (trelloID) {
          credentialNode = RED.nodes.node(trelloID);
        } else {
          credentialNode = RED.nodes.node(originalContext.trello);
        }

        const listSelector = $('#node-input-idList').selectTrelloList({});
        const boardSelector = $('#node-input-idBoard').selectTrelloBoard({});

        if (credentialNode) {
          if (credentialNode.apikey && credentialNode.token) {
            boardSelector.selectTrelloBoard('setOnSelect',
              function (e) {
                const board = $("#node-input-idBoard");
                const boardID = $(board).val(); // Gets the ID of the selected board

                listSelector.selectTrelloList('setBoard', credentialNode, boardID, originalContext.idList);

                if (boardID !== '') {
                  const membersURL = 'https://api.trello.com/1/boards/' + boardID + '/members?key=' + credentialNode.apikey + '&token=' + credentialNode.token;

                  $.get(membersURL, function (data, status) {
                    let container = $("#node-input-filterUserList-hints");
                    container.empty();

                    const text = $('<span>', {style: "color: grey; font-size: 11px"}).text('JSON dump of members on board \n' + JSON.stringify(data));
                    text.appendTo(container);
                  });
                }

              }
            );
            boardSelector.selectTrelloBoard('setCredentials', credentialNode,originalContext.idBoard);
          }
        } else { // No trello credentials fill both selection boxes with hints to select credentials
          boardList = $("#node-input-idBoard");
          boardList.empty();
          const boardListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
          const boardListFirstText = $('<span>', {class: "node-input-option-text"})
            .text(originalContext._(originalContext._("trelloGetList.hint.noTrelloCredentials")));
          boardListFirstText.appendTo(boardListFirstContainer);
          boardListFirstContainer.appendTo(boardList);

          const listList = $("#node-input-idList");
          listList.empty();
          const listListFirstContainer = $('<option/>', {class: "node-input-option-node", value: ''});
          const listListFirstText = $('<span>', {class: "node-input-option-text"})
            .text(originalContext._(originalContext._("trelloGetList.hint.noTrelloCredentials")));
          listListFirstText.appendTo(listListFirstContainer);
          listListFirstContainer.appendTo(listList);
        }
      }


      $("#node-input-trello").change(function (e) { // rerun if credentials changed
        const trelloID = $(this).val();
        setupHooks(trelloID);
      });


      // Populate the boxes with the only values we have stored
      if (this.idList) {
        const listList = $("#node-input-idList");
        listList.empty();
        const listListFirstContainer = $('<option/>', {class: "node-input-option-node", value: this.idList});
        const listListFirstText = $('<span>', {class: "node-input-option-text"}).text(this.idList);
        listListFirstText.appendTo(listListFirstContainer);
        listListFirstContainer.appendTo(listList);
      }

      if (this.idBoard) {
        let boardList = $("#node-input-idList");
        boardList.empty();
        const boardListFirstContainer = $('<option/>', {class: "node-input-option-node", value: this.idBoard});
        const boardListFirstText = $('<span>', {class: "node-input-option-text"}).text(this.idBoard);
        boardListFirstText.appendTo(boardListFirstContainer);
        boardListFirstContainer.appendTo(boardList);
      }

      setupHooks();
    }
  });
</script>

<script
        type="text/x-red"
        data-template-name="trelloGetList"
>
    <div class="form-row">
      <label for="node-input-trello">Trello</label>
      <input id="node-input-trello"></input>
    </div>
    <div class="form-row">
      <label for="node-input-idBoard" data-i18n="trelloGetList.label.selectBoardID"></label>
      <select id="node-input-idBoard" >
      </select>
    </div>
    <div class="form-row">
      <label for="node-input-idList" data-i18n="trelloGetList.label.selectListID"></label>
      <select id="node-input-idList" >
      </select>
    </div>
    <div class="form-row">
      <label for="node-input-outputAsArray" data-i18n="trelloGetList.label.outputAsArrayBoolean"></label>
      <input id="node-input-outputAsArray" type="checkbox"></input>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="trelloGetList.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]trelloGetList.label.name">
    </div>


</script>
